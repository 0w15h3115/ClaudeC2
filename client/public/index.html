# server/run.py
import uvicorn
import asyncio
import sys
from pathlib import Path
from api.main import app
from core.database import init_db
from core.config import settings
from listeners.http import HTTPListener
from listeners.dns import DNSListener
from listeners.websocket import WebSocketListener
import logging

# Configure logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

async def start_listeners():
    """Start all configured listeners"""
    listeners = []
    
    if settings.HTTP_LISTENER_ENABLED:
        http_listener = HTTPListener(
            host=settings.HTTP_LISTENER_HOST,
            port=settings.HTTP_LISTENER_PORT
        )
        listeners.append(http_listener.start())
        logger.info(f"Starting HTTP listener on {settings.HTTP_LISTENER_HOST}:{settings.HTTP_LISTENER_PORT}")
    
    if settings.DNS_LISTENER_ENABLED:
        dns_listener = DNSListener(
            host=settings.DNS_LISTENER_HOST,
            port=settings.DNS_LISTENER_PORT
        )
        listeners.append(dns_listener.start())
        logger.info(f"Starting DNS listener on {settings.DNS_LISTENER_HOST}:{settings.DNS_LISTENER_PORT}")
    
    if settings.WEBSOCKET_LISTENER_ENABLED:
        ws_listener = WebSocketListener(
            host=settings.WEBSOCKET_LISTENER_HOST,
            port=settings.WEBSOCKET_LISTENER_PORT
        )
        listeners.append(ws_listener.start())
        logger.info(f"Starting WebSocket listener on {settings.WEBSOCKET_LISTENER_HOST}:{settings.WEBSOCKET_LISTENER_PORT}")
    
    # Run all listeners concurrently
    await asyncio.gather(*listeners)

async def main():
    """Main startup function"""
    logger.info("Starting C2 Framework Server...")
    
    # Initialize database
    logger.info("Initializing database...")
    await init_db()
    
    # Start listeners in background
    asyncio.create_task(start_listeners())
    
    # Start FastAPI server
    config = uvicorn.Config(
        app,
        host=settings.API_HOST,
        port=settings.API_PORT,
        log_level="info",
        reload=settings.DEBUG
    )
    server = uvicorn.Server(config)
    
    logger.info(f"Starting API server on {settings.API_HOST}:{settings.API_PORT}")
    await server.serve()

if __name__ == "__main__":
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        logger.info("Server shutdown requested")
        sys.exit(0)
    except Exception as e:
        logger.error(f"Server error: {e}")
        sys.exit(1)
